---
- block:

  - name: configura a interfaces de rede
    copy:
      content: "{{ nspawn_container_interfaces }}"
      dest: "{{ nspawn_container_dir }}/etc/network/interfaces"

  - name: configura o dns do container
    copy:
      content: "{{ nspawn_container_resolv }}"
      dest: "{{ nspawn_container_dir }}/etc/resolv.conf"

  - name: configura o nome do container
    copy:
      content: "{{ nspawn_container_name }}"
      dest: "{{ nspawn_container_dir }}/etc/hostname"

  - name: configura hosts do container
    lineinfile:
      path: "{{ nspawn_container_dir }}/etc/hosts"
      regexp: "^127.0.0.1 {{ nspawn_container_name }}$"
      line: "127.0.0.1 {{ nspawn_container_name }}"
      state: present

  - name: inicia container
    command:
      warn=no
      machinectl start {{ nspawn_container_name }}
    changed_when: False

  delegate_to: "{{ nspawn_container_host }}"


- name: aguarda ssh em {{ nspawn_container_ip }}
  connection: local
  wait_for:
    host: '{{ nspawn_container_ip }}'
    port: 22
    state: present
    timeout: 60

- name: remove chaves de ssh em know_hosts local
  connection: local
  run_once: yes
  known_hosts:
    name: "{{ item }}"
    state: absent
  with_items:
    - "{{ nspawn_container_ip }}"
    - "{{ nspawn_container_name }}"

- name: cria arquivo de finalização do bootstrap
  file:
    path: "/etc/.stage2.ok"
    state: touch

- setup: {}
