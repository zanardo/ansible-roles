---
- block:

  - name: configura o ssh no container
    lineinfile:
      path: "/var/lib/machines/{{ nspawn_container_name }}/etc/ssh/sshd_config"
      regexp: "^#?PermitRootLogin.*$"
      line: "PermitRootLogin yes"
      state: present

  - name: cria o diretório de configurações do ssh
    file:
      state: directory
      path: "/var/lib/machines/{{ nspawn_container_name }}/root/.ssh"

  - name: libera a chave de ssh
    copy:
      content: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
      dest: "/var/lib/machines/{{ nspawn_container_name }}/root/.ssh/authorized_keys"

  - name: configura a interface de rede
    copy:
      content: |
        auto {{ nspawn_container_interface }}
        iface {{ nspawn_container_interface }} inet static
          address {{ nspawn_container_ip }}/24
          gateway {{ nspawn_container_gateway }}
      dest: "/var/lib/machines/{{ nspawn_container_name }}/etc/network/interfaces"

  - name: configura o dns do container
    copy:
      content: "{{ nspawn_container_resolv }}"
      dest: "/var/lib/machines/{{ nspawn_container_name }}/etc/resolv.conf"

  - name: configura o nome do container
    copy:
      content: "{{ nspawn_container_name }}"
      dest: "/var/lib/machines/{{ nspawn_container_name }}/etc/hostname"

  - name: configura hosts do container
    lineinfile:
      path: "/var/lib/machines/{{ nspawn_container_name }}/etc/hosts"
      regexp: "^127.0.0.1 {{ nspawn_container_name }}$"
      line: "127.0.0.1 {{ nspawn_container_name }}"
      state: present

  - name: inicia container
    command:
      warn=no
      machinectl start {{ nspawn_container_name }}
    changed_when: False

  delegate_to: "{{ nspawn_container_host }}"


- name: aguarda ssh em {{ virt_install_ip }}
  connection: local
  wait_for:
    host: '{{ nspawn_container_ip }}'
    port: 22
    state: present
    timeout: 60

- name: remove chaves de ssh em know_hosts local
  connection: local
  run_once: yes
  known_hosts:
    name: "{{ item }}"
    state: absent
  with_items:
    - "{{ nspawn_container_ip }}"
    - "{{ nspawn_container_name }}"

- name: configura timezone do container
  copy:
    content: "America/Sao_Paulo"
    dest: "/etc/timezone"
  register: timezone_changed

- name: configura timezone do container
  command: /usr/sbin/dpkg-reconfigure -f noninteractive tzdata
  when: timezone_changed is changed

- name: configura locales do container
  copy:
    content: |
      pt_BR.UTF-8 UTF-8
      en_US.UTF-8 UTF-8
    dest: "/etc/locale.gen"
  register: locales_changed

- name: configura locale default do container
  copy:
    content: |
      LANG="en_US.UTF-8"
      LANGUAGE="en_US:en"
    dest: "/etc/default/locale"

- name: gera locales do container
  command: "/usr/sbin/locale-gen"
  when: locales_changed is changed

- name: cria arquivo de finalização do bootstrap
  file:
    path: "/.stage2.ok"
    state: touch

- setup: {}
