---
- name: instala pacotes necessários
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - python-libvirt

- name: verifica se máquina virtual existe
  virt:
    command: list_vms
  register: virt_vms

- block:

  - name: instala máquina virtual {{ virt_install_name }}
    connection: local
    shell: virt-install
      --connect qemu+ssh://{{ ansible_host }}/system 
      --name {{ virt_install_name }} 
      {{ virt_install_args|join(' ') }}

  - name: aguarda porta tcp {{ virt_waitfor_port }} em {{ virt_install_ip }}
    connection: local
    wait_for:
      host: '{{ virt_install_ip }}'
      port: '{{ virt_waitfor_port }}'
      state: present
      timeout: '{{ virt_waitfor_timeout }}'
    when: 'virt_waitfor_port|d'

  - name: remove chave de ssh em know_hosts local
    connection: local
    failed_when: False
    command: ssh-keygen -R {{ virt_install_ip }}

  when: virt_install_name not in virt_vms.list_vms
