---
- setup:
  delegate_to: "{{ virt_install_vmhost }}"

- name: instala pacotes necessários - debian
  apt:
    name:
      - python-libvirt
      - virtinst
    state: present
    install_recommends: no
  delegate_to: "{{ virt_install_vmhost }}"

- name: verifica se máquina virtual existe
  virt:
    command: list_vms
  register: virt_vms
  check_mode: no
  delegate_to: "{{ virt_install_vmhost }}"

- block:

  - name: instala máquina virtual {{ virt_install_name }}
    connection: local
    shell: http_proxy="{{ virt_install_http_proxy|d('') }}" virt-install
      --connect qemu:///system
      --name {{ virt_install_name }}
      {{ virt_install_args|join(' ') }}
    delegate_to: "{{ virt_install_vmhost }}"

  - name: aguarda porta tcp {{ virt_waitfor_port }} em {{ virt_install_ip }}
    connection: local
    wait_for:
      host: '{{ virt_install_ip }}'
      port: '{{ virt_waitfor_port }}'
      state: present
      timeout: '{{ virt_waitfor_timeout }}'
    when: 'virt_waitfor_port|d'

  - name: remove chaves de ssh em know_hosts local
    connection: local
    known_hosts:
      name: "{{ item }}"
      state: absent
    with_items:
      - "{{ virt_install_ip }}"
      - "{{ virt_install_name }}"

  when: virt_install_name not in virt_vms.list_vms

- setup: {}
